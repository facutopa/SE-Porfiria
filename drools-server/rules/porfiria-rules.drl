/**
 * Sistema de Puntuación para Diagnóstico de Porfiria
 * 
 * Basado en las reglas médicas específicas para evaluación de Porfiria
 * con sistema de puntuación por categorías clínicas.
 */

package com.porfiria.rules;

import java.util.List;
import java.util.ArrayList;

// Declaración de tipos de hechos
declare Patient
    id: String
    firstName: String
    lastName: String
    dni: String
    age: int
    gender: String
    familyHistory: boolean
    medications: List<String>
    alcoholConsumption: boolean
    fastingStatus: boolean
end

declare QuestionnaireResponse
    questionId: String
    answer: String
    patientId: String
    timestamp: java.util.Date
end

// Cuadro clínico con puntuaciones por categoría
declare CuadroClinico
    patientId: String
    
    // Puntuaciones por categorías de síntomas
    sintomasCutanea: int
    sintomasAguda: int
    anamnesis: int
    
    // Puntuación total
    puntuacionTotal: int
    
    // Tipo de Porfiria sugerido
    tipoPorfiria: String // "AGUDA", "CUTANEA", "MIXTA", "NO_APLICA"
    
    // Nivel de riesgo
    nivelRiesgo: String // "ALTO", "MEDIO", "BAJO"
end

declare DiagnosticoTemprano
    patientId: String
    sintomaCutanea: String // "Presenta", "No_Presenta", null
    sintomaAguda: String   // "Presenta", "No_Presenta", null
end

declare GenerarOrden
    patientId: String
    estudios: List<String>
end

declare InformarWeb
    patientId: String
    medicamentosContraproducentes: List<String>
end

declare Recommendation
    testType: String
    confidence: String
    message: String
    score: int
    criticalSymptoms: int
    reasoning: List<String>
    riskFactors: List<String>
    
    // Nuevos campos para el sistema
    estudiosRecomendados: List<String>
    medicamentosContraproducentes: List<String>
    tipoPorfiria: String
    cuadroClinico: CuadroClinico
end

// ========================================
// REGLAS DE PUNTUACIÓN - SÍNTOMAS CUTÁNEOS
// ========================================

// REG-001: Máculas (+2 puntos)
rule "REG-001 - Máculas"
    when
        $patient: Patient()
        $response: QuestionnaireResponse(questionId == "maculas", answer == "SI")
        not CuadroClinico(patientId == $patient.id)
    then
        System.out.println("REG-001: Máculas detectadas");
        CuadroClinico cuadro = new CuadroClinico();
        cuadro.setPatientId($patient.id);
        cuadro.setSintomasCutanea(2);
        cuadro.setSintomasAguda(0);
        cuadro.setAnamnesis(0);
        cuadro.setPuntuacionTotal(2);
        insert(cuadro);
end

// REG-002: Fragilidad Cutánea (+5 puntos)
rule "REG-002 - Fragilidad Cutánea"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "fragilidadCutanea", answer == "SI")
    then
        System.out.println("REG-002: Fragilidad cutánea detectada");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 5;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-003: Hipertricosis (+4 puntos)
rule "REG-003 - Hipertricosis"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "hipertricosis", answer == "SI")
    then
        System.out.println("REG-003: Hipertricosis detectada");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 4;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 4);
        update($cuadro);
end

// REG-004: Nódulos (+1 punto)
rule "REG-004 - Nódulos"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "nodulos", answer == "SI")
    then
        System.out.println("REG-004: Nódulos detectados");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-005: Lesiones Oculares (+1 punto)
rule "REG-005 - Lesiones Oculares"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "lesionesOculares", answer == "SI")
    then
        System.out.println("REG-005: Lesiones oculares detectadas");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-006: Costras (+3 puntos)
rule "REG-006 - Costras"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "costras", answer == "SI")
    then
        System.out.println("REG-006: Costras detectadas");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 3;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-007: Quistes de Milia (+3 puntos)
rule "REG-007 - Quistes de Milia"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "quistesMilia", answer == "SI")
    then
        System.out.println("REG-007: Quistes de milia detectados");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 3;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-008: Hiperpigmentación (+5 puntos)
rule "REG-008 - Hiperpigmentación"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "hiperpigmentacion", answer == "SI")
    then
        System.out.println("REG-008: Hiperpigmentación detectada");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 5;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-009: Ampollas (+5 puntos)
rule "REG-009 - Ampollas"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "ampollas", answer == "SI")
    then
        System.out.println("REG-009: Ampollas detectadas");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 5;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-010: Fotosensibilidad (+5 puntos)
rule "REG-010 - Fotosensibilidad"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "fotosensibilidad", answer == "SI")
    then
        System.out.println("REG-010: Fotosensibilidad detectada");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 5;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-011: Pruritos (+2 puntos)
rule "REG-011 - Pruritos"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "pruritos", answer == "SI")
    then
        System.out.println("REG-011: Pruritos detectados");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 2;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 2);
        update($cuadro);
end

// REG-012: Tricosis (+3 puntos)
rule "REG-012 - Tricosis"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "tricosis", answer == "SI")
    then
        System.out.println("REG-012: Tricosis detectada");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 3;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// ========================================
// REGLAS DE PUNTUACIÓN - SÍNTOMAS AGUDOS
// ========================================

// REG-013: Trastornos Psiquiátricos (+4 puntos)
rule "REG-013 - Trastornos Psiquiátricos"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "trastornosPsiquiatricos", answer == "SI")
    then
        System.out.println("REG-013: Trastornos psiquiátricos detectados");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 4;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 4);
        update($cuadro);
end

// REG-014: Parestesias (+5 puntos)
rule "REG-014 - Parestesias"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "parestesias", answer == "SI")
    then
        System.out.println("REG-014: Parestesias detectadas");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 5;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-015: Cefaleas (+3 puntos)
rule "REG-015 - Cefaleas"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "cefaleas", answer == "SI")
    then
        System.out.println("REG-015: Cefaleas detectadas");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 3;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-016: Paresia (+5 puntos)
rule "REG-016 - Paresia"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "paresia", answer == "SI")
    then
        System.out.println("REG-016: Paresia detectada");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 5;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-017: Convulsiones (+3 puntos)
rule "REG-017 - Convulsiones"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "convulsiones", answer == "SI")
    then
        System.out.println("REG-017: Convulsiones detectadas");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 3;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-018: Trastornos Abdominales (+5 puntos)
rule "REG-018 - Trastornos Abdominales"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "trastornosAbdominales", answer == "SI")
    then
        System.out.println("REG-018: Trastornos abdominales detectados");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 5;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-019: Síndrome Ácido Sensitivo (+2 puntos)
rule "REG-019 - Síndrome Ácido Sensitivo"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "sindromeAcidoSensitivo", answer == "SI")
    then
        System.out.println("REG-019: Síndrome ácido sensitivo detectado");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 2;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 2);
        update($cuadro);
end

// REG-020: Palpitaciones (+3 puntos)
rule "REG-020 - Palpitaciones"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "palpitaciones", answer == "SI")
    then
        System.out.println("REG-020: Palpitaciones detectadas");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 3;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-021: Anorexia (+2 puntos)
rule "REG-021 - Anorexia"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "anorexia", answer == "SI")
    then
        System.out.println("REG-021: Anorexia detectada");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 2;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 2);
        update($cuadro);
end

// REG-022: Estrés (+5 puntos)
rule "REG-022 - Estrés"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "estres", answer == "SI")
    then
        System.out.println("REG-022: Estrés detectado");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 5;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-023: Trastornos Neurológicos (+4 puntos)
rule "REG-023 - Trastornos Neurológicos"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "trastornosNeurologicos", answer == "SI")
    then
        System.out.println("REG-023: Trastornos neurológicos detectados");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 4;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 4);
        update($cuadro);
end

// REG-024: Dolores Musculares (+3 puntos)
rule "REG-024 - Dolores Musculares"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "doloresMusculares", answer == "SI")
    then
        System.out.println("REG-024: Dolores musculares detectados");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 3;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-025: Mareos (+3 puntos)
rule "REG-025 - Mareos"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "mareos", answer == "SI")
    then
        System.out.println("REG-025: Mareos detectados");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 3;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-026: Parálisis (+4 puntos)
rule "REG-026 - Parálisis"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "paralisis", answer == "SI")
    then
        System.out.println("REG-026: Parálisis detectada");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 4;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 4);
        update($cuadro);
end

// REG-027: Dolor Abdominal/Lumbar (+5 puntos)
rule "REG-027 - Dolor Abdominal/Lumbar"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "dolorAbdominalLumbar", answer == "SI")
    then
        System.out.println("REG-027: Dolor abdominal/lumbar detectado");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 5;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-028: Constipación (+3 puntos)
rule "REG-028 - Constipación"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "constipacion", answer == "SI")
    then
        System.out.println("REG-028: Constipación detectada");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 3;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 3);
        update($cuadro);
end

// REG-029: Astenia (+4 puntos)
rule "REG-029 - Astenia"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "astenia", answer == "SI")
    then
        System.out.println("REG-029: Astenia detectada");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 4;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 4);
        update($cuadro);
end

// ========================================
// REGLAS DE PUNTUACIÓN - ANAMNESIS
// ========================================

// REG-030: Color Orina Oscura/Ámbar (+5 puntos)
rule "REG-030 - Color Orina Oscura/Ámbar"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "colorOrina", answer == "Oscura")
    then
        System.out.println("REG-030: Color orina oscura/ámbar detectado");
        int nuevosPuntos = $cuadro.getAnamnesis() + 5;
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-031: Familiares (+5 puntos)
rule "REG-031 - Familiares"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "familiares", answer == "SI")
    then
        System.out.println("REG-031: Antecedentes familiares detectados");
        int nuevosPuntos = $cuadro.getAnamnesis() + 5;
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-032: Diabetes (+0.5 puntos)
rule "REG-032 - Diabetes"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "diabetes", answer == "SI")
    then
        System.out.println("REG-032: Diabetes detectada");
        int nuevosPuntos = $cuadro.getAnamnesis() + 1; // Redondeado a 1 punto
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-033: HTA (+0.5 puntos)
rule "REG-033 - HTA"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "hta", answer == "SI")
    then
        System.out.println("REG-033: HTA detectada");
        int nuevosPuntos = $cuadro.getAnamnesis() + 1; // Redondeado a 1 punto
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-034: Tiroides (+0.5 puntos)
rule "REG-034 - Tiroides"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "tiroides", answer == "SI")
    then
        System.out.println("REG-034: Tiroides detectada");
        int nuevosPuntos = $cuadro.getAnamnesis() + 1; // Redondeado a 1 punto
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-035: Celiaquía (+0.5 puntos)
rule "REG-035 - Celiaquía"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "celiaquia", answer == "SI")
    then
        System.out.println("REG-035: Celiaquía detectada");
        int nuevosPuntos = $cuadro.getAnamnesis() + 1; // Redondeado a 1 punto
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-036: Lupus (+0.5 puntos)
rule "REG-036 - Lupus"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "lupus", answer == "SI")
    then
        System.out.println("REG-036: Lupus detectado");
        int nuevosPuntos = $cuadro.getAnamnesis() + 1; // Redondeado a 1 punto
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-037: Operaciones (+1 punto a síntomas cutáneos)
rule "REG-037 - Operaciones"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "operaciones", answer == "SI")
    then
        System.out.println("REG-037: Operaciones detectadas");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-038: Contacto Policlorados (+1 punto a síntomas cutáneos)
rule "REG-038 - Contacto Policlorados"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "contactoPoliclorados", answer == "SI")
    then
        System.out.println("REG-038: Contacto policlorados detectado");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-039: Contacto Otras Drogas (+1 punto a síntomas cutáneos)
rule "REG-039 - Contacto Otras Drogas"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "contactoOtrasDrogas", answer == "SI")
    then
        System.out.println("REG-039: Contacto otras drogas detectado");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-040: Contacto Plomo (+0.5 puntos a síntomas agudos)
rule "REG-040 - Contacto Plomo"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "contactoPlomo", answer == "SI")
    then
        System.out.println("REG-040: Contacto plomo detectado");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 1; // Redondeado a 1 punto
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-041: Contacto Otros Metales (+0.5 puntos a síntomas agudos)
rule "REG-041 - Contacto Otros Metales"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "contactoOtrosMetales", answer == "SI")
    then
        System.out.println("REG-041: Contacto otros metales detectado");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 1; // Redondeado a 1 punto
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-042: Cercanía Fábrica (+1 punto a síntomas cutáneos)
rule "REG-042 - Cercanía Fábrica"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "cercaniaFabrica", answer == "SI")
    then
        System.out.println("REG-042: Cercanía fábrica detectada");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-043: Contacto Veneno (+1 punto a síntomas cutáneos)
rule "REG-043 - Contacto Veneno"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "contactoVeneno", answer == "SI")
    then
        System.out.println("REG-043: Contacto veneno detectado");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-044: Contacto Derivado Petróleo (+1 punto a síntomas cutáneos)
rule "REG-044 - Contacto Derivado Petróleo"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "contactoDerivadoPetroleo", answer == "SI")
    then
        System.out.println("REG-044: Contacto derivado petróleo detectado");
        int nuevosPuntos = $cuadro.getSintomasCutanea() + 1;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 1);
        update($cuadro);
end

// REG-045: Consume Alcohol (+5 puntos a anamnesis)
rule "REG-045 - Consume Alcohol"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "consumeAlcohol", answer == "SI")
    then
        System.out.println("REG-045: Consumo alcohol detectado");
        int nuevosPuntos = $cuadro.getAnamnesis() + 5;
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-046: Fuma (+2 puntos a anamnesis)
rule "REG-046 - Fuma"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "fuma", answer == "SI")
    then
        System.out.println("REG-046: Fuma detectado");
        int nuevosPuntos = $cuadro.getAnamnesis() + 2;
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 2);
        update($cuadro);
end

// REG-047: Barbitúricos (+5 puntos a síntomas agudos)
rule "REG-047 - Barbitúricos"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "barbituricos", answer == "SI")
    then
        System.out.println("REG-047: Barbitúricos detectados");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 5;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-048: Medicamentos Hormonas (+5 puntos a anamnesis)
rule "REG-048 - Medicamentos Hormonas"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "medicamentosHormonas", answer == "SI")
    then
        System.out.println("REG-048: Medicamentos hormonas detectados");
        int nuevosPuntos = $cuadro.getAnamnesis() + 5;
        $cuadro.setAnamnesis(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 5);
        update($cuadro);
end

// REG-049: Anomalías Períodos Menstruales (+4 puntos a síntomas agudos)
rule "REG-049 - Anomalías Períodos Menstruales"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "anomaliasPeriodosMenstruales", answer == "SI")
    then
        System.out.println("REG-049: Anomalías períodos menstruales detectadas");
        int nuevosPuntos = $cuadro.getSintomasAguda() + 4;
        $cuadro.setSintomasAguda(nuevosPuntos);
        $cuadro.setPuntuacionTotal($cuadro.getPuntuacionTotal() + 4);
        update($cuadro);
end

// ========================================
// REGLAS DE DIAGNÓSTICO
// ========================================

// REG-050: Determinar sintomatología Cutánea (>= 22 puntos)
rule "REG-050 - Determinar Sintomatología Cutánea"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id, sintomasCutanea >= 22)
        not DiagnosticoTemprano(patientId == $patient.id)
    then
        System.out.println("REG-050: Sintomatología cutánea detectada (>= 22 puntos)");
        DiagnosticoTemprano diagnostico = new DiagnosticoTemprano();
        diagnostico.setPatientId($patient.id);
        diagnostico.setSintomaCutanea("Presenta");
        diagnostico.setSintomaAguda("No_Presenta");
        insert(diagnostico);
end

// REG-051: Determinar sintomatología Aguda (>= 36 puntos)
rule "REG-051 - Determinar Sintomatología Aguda"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id, sintomasAguda >= 36)
        not DiagnosticoTemprano(patientId == $patient.id)
    then
        System.out.println("REG-051: Sintomatología aguda detectada (>= 36 puntos)");
        DiagnosticoTemprano diagnostico = new DiagnosticoTemprano();
        diagnostico.setPatientId($patient.id);
        diagnostico.setSintomaCutanea("No_Presenta");
        diagnostico.setSintomaAguda("Presenta");
        insert(diagnostico);
end

// REG-052: Determinar sintomatología Aguda (>= 36 puntos OR anamnesis >= 12)
rule "REG-052 - Determinar Sintomatología Aguda Alternativa"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id, sintomasAguda >= 36)
        not DiagnosticoTemprano(patientId == $patient.id)
    then
        System.out.println("REG-052: Sintomatología aguda detectada (alternativa)");
        DiagnosticoTemprano diagnostico = new DiagnosticoTemprano();
        diagnostico.setPatientId($patient.id);
        diagnostico.setSintomaCutanea("No_Presenta");
        diagnostico.setSintomaAguda("Presenta");
        insert(diagnostico);
end

// REG-053: Determinar sintomatología Cutánea (anamnesis >= 12)
rule "REG-053 - Determinar Sintomatología Cutánea Alternativa"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id, anamnesis >= 12)
        not DiagnosticoTemprano(patientId == $patient.id)
    then
        System.out.println("REG-053: Sintomatología cutánea detectada (anamnesis >= 12)");
        DiagnosticoTemprano diagnostico = new DiagnosticoTemprano();
        diagnostico.setPatientId($patient.id);
        diagnostico.setSintomaCutanea("Presenta");
        diagnostico.setSintomaAguda("No_Presenta");
        insert(diagnostico);
end

// ========================================
// REGLAS DE ORDENES DE ESTUDIOS
// ========================================

// REG-054: Ordenar estudios Porfiria Aguda
rule "REG-054 - Ordenar Estudios Porfiria Aguda"
    when
        $patient: Patient()
        $diagnostico: DiagnosticoTemprano(patientId == $patient.id, sintomaAguda == "Presenta")
        not GenerarOrden(patientId == $patient.id)
    then
        System.out.println("REG-054: Generando órdenes para Porfiria Aguda");
        
        List<String> estudios = new ArrayList<>();
        estudios.add("PBG (Porfobilinógeno)");
        estudios.add("IPP (Isómeros de Porfirinas)");
        estudios.add("ALA (Ácido Aminolevulínico)");
        estudios.add("PTO (Porfirinas Totales en Orina)");
        
        GenerarOrden orden = new GenerarOrden();
        orden.setPatientId($patient.id);
        orden.setEstudios(estudios);
        insert(orden);
end

// REG-055: Ordenar estudios Porfiria Cutánea
rule "REG-055 - Ordenar Estudios Porfiria Cutánea"
    when
        $patient: Patient()
        $diagnostico: DiagnosticoTemprano(patientId == $patient.id, sintomaCutanea == "Presenta")
        not GenerarOrden(patientId == $patient.id)
    then
        System.out.println("REG-055: Generando órdenes para Porfiria Cutánea");
        
        List<String> estudios = new ArrayList<>();
        estudios.add("IPP (Isómeros de Porfirinas)");
        estudios.add("PTO (Porfirinas Totales en Orina)");
        estudios.add("CRO (Coproporfirinas)");
        estudios.add("PBG (Porfobilinógeno)");
        
        GenerarOrden orden = new GenerarOrden();
        orden.setPatientId($patient.id);
        orden.setEstudios(estudios);
        insert(orden);
end

// ========================================
// REGLAS DE MEDICAMENTOS CONTRAPRODUCENTES
// ========================================

// REG-056: Informar Medicamentos Contraproducentes
rule "REG-056 - Informar Medicamentos Contraproducentes"
    when
        $patient: Patient()
        $diagnostico: DiagnosticoTemprano(
            patientId == $patient.id,
            sintomaCutanea == "Presenta" || sintomaAguda == "Presenta"
        )
        not InformarWeb(patientId == $patient.id)
    then
        System.out.println("REG-056: Informando medicamentos contraproducentes");
        
        List<String> medicamentos = new ArrayList<>();
        
        // Medicamentos contraindicados para Porfiria Aguda
        if ($diagnostico.getSintomaAguda() == "Presenta") {
            medicamentos.add("Barbitúricos");
            medicamentos.add("Sulfonamidas");
            medicamentos.add("Estrógenos");
            medicamentos.add("Progestágenos");
            medicamentos.add("Anticonvulsivantes");
            medicamentos.add("Griseofulvina");
            medicamentos.add("Rifampicina");
            medicamentos.add("Ergotamina");
            medicamentos.add("Anticonceptivos orales");
            medicamentos.add("Ketoconazol");
            medicamentos.add("Metildopa");
            medicamentos.add("Piroxicam");
            medicamentos.add("Espironolactona");
        }
        
        // Medicamentos contraindicados para Porfiria Cutánea
        if ($diagnostico.getSintomaCutanea() == "Presenta") {
            medicamentos.add("Tetraciclinas");
            medicamentos.add("Nalidíxico");
            medicamentos.add("Furosemida");
            medicamentos.add("Sulfonilureas");
            medicamentos.add("Estrógenos");
            medicamentos.add("Alcohol");
            medicamentos.add("Hierro");
            medicamentos.add("Retinoides");
            medicamentos.add("Cloroquina");
            medicamentos.add("Hidroxicloroquina");
        }
        
        InformarWeb informar = new InformarWeb();
        informar.setPatientId($patient.id);
        informar.setMedicamentosContraproducentes(medicamentos);
        insert(informar);
end

// ========================================
// REGLAS DE RECOMENDACIÓN FINAL
// ========================================

rule "Generar Recomendación Final"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $diagnostico: DiagnosticoTemprano(patientId == $patient.id)
        $orden: GenerarOrden(patientId == $patient.id)
        $informar: InformarWeb(patientId == $patient.id)
        not Recommendation()
    then
        System.out.println("Generando recomendación final");
        
        List<String> reasoning = new ArrayList<>();
        List<String> riskFactors = new ArrayList<>();
        
        // Agregar razonamiento basado en puntuaciones
        if ($cuadro.getSintomasCutanea() >= 22) {
            reasoning.add("Síntomas cutáneos significativos (" + $cuadro.getSintomasCutanea() + " puntos)");
        }
        if ($cuadro.getSintomasAguda() >= 36) {
            reasoning.add("Síntomas agudos significativos (" + $cuadro.getSintomasAguda() + " puntos)");
        }
        if ($cuadro.getAnamnesis() >= 12) {
            reasoning.add("Antecedentes relevantes (" + $cuadro.getAnamnesis() + " puntos)");
        }
        
        // Determinar tipo de recomendación
        String testType;
        String confidence;
        String message;
        
        if ($diagnostico.getSintomaAguda() == "Presenta") {
            testType = "PBG_URINE_TEST";
            confidence = "high";
            message = "Se recomienda realizar estudios urgentes para Porfiria Aguda. La combinación de síntomas y puntuación total (" + 
                     $cuadro.getPuntuacionTotal() + " puntos) sugiere alta probabilidad.";
        } else if ($diagnostico.getSintomaCutanea() == "Presenta") {
            testType = "PBG_URINE_TEST";
            confidence = "high";
            message = "Se recomienda realizar estudios para Porfiria Cutánea. Los síntomas cutáneos y puntuación total (" + 
                     $cuadro.getPuntuacionTotal() + " puntos) sugieren alta probabilidad.";
        } else {
            testType = "FOLLOW_UP_REQUIRED";
            confidence = "medium";
            message = "Se recomienda seguimiento clínico. La puntuación total (" + 
                     $cuadro.getPuntuacionTotal() + " puntos) sugiere necesidad de monitoreo.";
        }
        
        // Crear recomendación final
        Recommendation recommendation = new Recommendation();
        recommendation.setTestType(testType);
        recommendation.setConfidence(confidence);
        recommendation.setMessage(message);
        recommendation.setScore($cuadro.getPuntuacionTotal());
        recommendation.setCriticalSymptoms(
            ($cuadro.getSintomasAguda() >= 36 ? 2 : 0) + 
            ($cuadro.getSintomasCutanea() >= 22 ? 1 : 0)
        );
        recommendation.setReasoning(reasoning);
        recommendation.setRiskFactors(riskFactors);
        recommendation.setEstudiosRecomendados($orden.getEstudios());
        recommendation.setMedicamentosContraproducentes($informar.getMedicamentosContraproducentes());
        recommendation.setTipoPorfiria($diagnostico.getSintomaAguda() == "Presenta" ? "AGUDA" : 
                                     $diagnostico.getSintomaCutanea() == "Presenta" ? "CUTANEA" : "NO_APLICA");
        recommendation.setCuadroClinico($cuadro);
        
        insert(recommendation);
end